<html>
<head>

    <style>
        .heightClass{
            height: 100%;
            overflow: hidden;
        }

        #legend {
            font-family: Arial, sans-serif;
            background: #fff;
            padding: 10px;
            /*margin: 10px;*/
            border: 3px solid #000;
            width: 80%;
            height: 15%;
            overflow: scroll;
        }
        #legend h4 {
            margin-top: 0;
        }

        th, td {
            border: 1px solid #000;
        }

        .tableClass{
            width: 100%;
            height: 80%;
            overflow: scroll;
            border: 1px solid #000;
        }

    </style>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script type="text/javascript" src="./js.sources/moment.js"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.5/umd/popper.js"/>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.bundle.js">
        $(document).ready(function() {
            $(".dropdown-toggle").dropdown();
        });
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/eonasdan-bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
</head>
<body onload="initialize()">

<div class="container-fluid">
        <!-- Header row -->
        <div class="row bg-primary">
            <!-- Unique code column-->
            <div class="col-sm-2">
                <!--<span>Device unique code:</span>-->
                <input id="deviceUniqueCode" type='text' class="form-control"/>
            </div>

            <!-- Start date column-->
            <div class='col-sm-4'>
                <div class="form-group">
                    <div class='input-group date' id='startDateTimePicker'>
                        <input type='text' class="form-control" />
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                    </div>
                </div>
            </div>

            <!-- End date column-->
            <div class='col-sm-4'>
                <div class="form-group">
                    <div class='input-group date' id='endDateTimePicker'>
                        <input type='text' class="form-control" />
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                    </div>
                </div>
            </div>

            <!-- Time zone column-->
            <div class='col-sm-1'>
                <div class="btn-group">
                    <button id="timeZoneTypeButton" type="button" class="btn btn-secondary dropdown-toggle btn-sm-2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Action</button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="#">Action</a>
                        <a class="dropdown-item" href="#">Another action</a>
                        <a class="dropdown-item" href="#">Something else here</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Separated link</a>
                    </div>
                </div>
            </div>

            <!-- Send button column-->
            <div class='col-sm-1'>
                <div class="btn-group">
                    <button onclick="track()" type="button" class="btn btn-success dropdown-toggle btn-sm-2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Track
                    </button>
                </div>
            </div>

        </div>
    <div class="row">
        <div class="col heightClass" id="map"></div>
        <div id="legend"><h4>Tracking results</h4></div>
    </div>

</div>

<!--<div class="container-fluid">-->
    <!-- Google maps row -->


<!--</div>-->
<!--<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC128Q00uK83vyquPcQTmgGSWJQ4nizR7A&callback=initMap" type="text/javascript"></script>-->
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script type="text/javascript">
   var mapVariable;
    $(function () {
        $('#startDateTimePicker').datetimepicker();
    });

    $(function () {
        $('#endDateTimePicker').datetimepicker();
    });

    $(".form_datetime").datetimepicker({
        format: "dd MM yyyy - hh:ii"
    });


    function track() {
        let deviceUniqueCode = $('#deviceUniqueCode').val();

        if (deviceUniqueCode === "") {
            alert("Please add device unique code.");
            return;
        }

        let startDateTime = $('#startDateTimePicker').data("DateTimePicker").date();
        if (startDateTime != null) {
            startDateTime = startDateTime.format("YYYY-MM-DDTHH:mm");
        }

        let endDateTime = $('#endDateTimePicker').data("DateTimePicker").date();
        if (endDateTime != null) {
            endDateTime = endDateTime.format("YYYY-MM-DDTHH:mm");
        }

        if (startDateTime == null) {
            alert("Please add start date at least.");
            return;
        }

        let timeZoneType = $('#timeZoneTypeButton').html();

        if (deviceUniqueCode != "" && (startDateTime != null)) {
            let trackingObject = new Object();
            trackingObject.deviceUniqueCode = deviceUniqueCode;
            trackingObject.startDateTime = startDateTime;
            trackingObject.endDateTime = endDateTime;
//            trackingObject.timeZoneType = timeZoneType;
            trackingObject.timeZoneType = "UTC";

            let jsonString = JSON.stringify(trackingObject);
            sendToServer(jsonString);
        } else if (deviceUniqueCode != "") {
            // TODO send get request to start socket communication
        }

    }

    function sendToServer(jsonString) {
        console.log(mapVariable);
        $.ajax({
            type: "POST",
            url: "/web/track/period",
            data: jsonString,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(data){
                console.log(mapVariable);
                parseReturnedCoordinates(data);
            },
            failure: function(errMsg) {
                console.log(data)
            }
        });
    }

// Google maps script below

    function initialize() {

        var uluru = {lat: 54, lng: 54};
        mapVariable = new google.maps.Map(
                document.getElementById('map'), {zoom: 3, center: uluru, mapTypeId: google.maps.MapTypeId.ROADMAP});

        var legend = document.getElementById('legend');
        var div = document.createElement('div');
        div.appendChild(createTable(50));
        legend.appendChild(div);


        mapVariable.controls[google.maps.ControlPosition.BOTTOM].push(legend);
    };

    function createTable(numRows) {
        let tableElement = document.createElement('table');
        let headerRow = document.createElement('tr');
        let headerLatitudeColumn = document.createElement('td');
        headerLatitudeColumn.innerHTML = "latitude";
        let headerLongitudeColumn = document.createElement('td');
        headerLongitudeColumn.innerHTML = "longitude";
        let headerTimeColumnColumn = document.createElement('td');
        headerTimeColumnColumn.innerHTML = "time";

        for (let i = 0; i < numRows; i++) {
            let row = document.createElement('tr');
            let latitudeColumn = document.createElement('td');
            latitudeColumn.innerHTML = "latitude";
            let longitudeColumn = document.createElement('td');
            longitudeColumn.innerHTML = "longitude";
            let timeColumnColumn = document.createElement('td');
            timeColumnColumn.innerHTML = "time";

            row.appendChild(latitudeColumn);
            row.appendChild(longitudeColumn);
            row.appendChild(timeColumnColumn);
            row.setAttribute("id", "row" + i);
            row.setAttribute("onclick", "moveMarker(" + row  + ")");
            tableElement.appendChild(row);
        }

        tableElement.className += " tableClass";
        return tableElement;
    }

   function moveMarker(row) {

       console.log("selected row");
//       marker = new google.maps.Marker( {position: new google.maps.LatLng( latitude, longitude ), map: mapVariable} );
//       marker.setPosition( new google.maps.LatLng( latitude, longitude ) );
//       marker.setMap(mapVariable);
//       mapVariable.panTo( new google.maps.LatLng( latitude, longitude ) );
//       mapVariable.setZoom(13);

   };

    function moveMarker(latitude, longitude ) {

        marker = new google.maps.Marker( {position: new google.maps.LatLng( latitude, longitude ), map: mapVariable} );
        marker.setPosition( new google.maps.LatLng( latitude, longitude ) );
        marker.setMap(mapVariable);
        mapVariable.panTo( new google.maps.LatLng( latitude, longitude ) );
        mapVariable.setZoom(13);

    };

    function parseReturnedCoordinates(listOfCoordinates) {
        if (listOfCoordinates.length == 1) {
            let latitude = listOfCoordinates[0].latitude;
            let longitude = listOfCoordinates[0].longitude;
            console.log("latitudeeee-----> " + latitude);
            console.log("longi-----> " + longitude);
            moveMarker(latitude, longitude);
        }
//        for (let i=0; i < coordinates.size(); i++) {
//
//        }
    }

</script>

</body>
</html>